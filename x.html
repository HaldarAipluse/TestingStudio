<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Social Media App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles can be added here if needed */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app">

        <!-- Authentication Section -->
        <div id="auth-container" class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-xl">
            <div id="login-view">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-300">Login</button>
                    <p id="login-error" class="text-red-500 mt-3 text-center"></p>
                </form>
                <p class="mt-4 text-center text-gray-600">Don't have an account? <a href="#" id="show-register" class="text-blue-500 hover:underline">Register</a></p>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Register</h2>
                <form id="register-form">
                     <div class="mb-4">
                        <label for="register-username" class="block text-gray-700 font-semibold mb-2">Username</label>
                        <input type="text" id="register-username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 font-semibold mb-2">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition duration-300">Register</button>
                    <p id="register-error" class="text-red-500 mt-3 text-center"></p>
                </form>
                <p class="mt-4 text-center text-gray-600">Already have an account? <a href="#" id="show-login" class="text-blue-500 hover:underline">Login</a></p>
            </div>
        </div>

        <!-- Main App Content (hidden by default) -->
        <div id="main-content" class="hidden">
            <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <h1 class="text-2xl font-bold text-blue-600">SocialApp</h1>
                <div>
                    <button id="home-btn" class="px-4 py-2 rounded-lg hover:bg-gray-200 transition duration-300">Home</button>
                    <button id="profile-btn" class="px-4 py-2 rounded-lg hover:bg-gray-200 transition duration-300">Profile</button>
                    <button id="logout-btn" class="ml-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
                </div>
            </nav>

            <!-- Home/Feed View -->
            <div id="home-view" class="max-w-2xl mx-auto mt-6 px-4">
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Create a Post</h2>
                    <form id="post-form">
                        <textarea id="post-text" class="w-full p-2 border rounded-lg" rows="4" placeholder="What's on your mind?" maxlength="280"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <p id="char-count" class="text-right text-gray-500">280</p>
                            <div>
                                <label for="post-image" class="cursor-pointer text-blue-500 hover:text-blue-700 mr-4">
                                    <span>ðŸ“· Image</span>
                                    <input type="file" id="post-image" class="hidden" accept="image/*">
                                </label>
                                <label for="post-video" class="cursor-pointer text-blue-500 hover:text-blue-700">
                                   <span>ðŸŽ¬ Video</span>
                                    <input type="file" id="post-video" class="hidden" accept="video/*">
                                </label>
                            </div>
                        </div>
                         <p id="file-upload-status" class="text-sm text-gray-600 mt-2"></p>
                        <button type="submit" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-300">Post</button>
                    </form>
                </div>

                <div id="feed">
                    <!-- Posts will be dynamically inserted here -->
                </div>
                <button id="load-more" class="w-full mt-4 bg-gray-200 py-2 rounded-lg hover:bg-gray-300 transition duration-300 hidden">Load More</button>
            </div>

            <!-- Profile View -->
            <div id="profile-view" class="hidden max-w-2xl mx-auto mt-6 px-4">
                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <img id="profile-pic" src="https://via.placeholder.com/150" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-gray-200">
                    <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                    <button id="change-profile-pic-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">Change Picture</button>
                    <h2 id="profile-username" class="text-3xl font-bold mt-4 text-gray-800"></h2>
                    <p id="profile-email" class="text-md text-gray-500"></p>
                </div>
                <h3 class="mt-8 text-2xl font-bold text-gray-700 mb-4">Your Posts</h3>
                <div id="user-posts">
                    <!-- User's posts will be dynamically inserted here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs - Using version 8 for compatibility with the compat libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBF8WGFStX62SCFqhMzqcvIFI0LZTJfd30",
            authDomain: "social-media-420.firebaseapp.com",
            databaseURL: "https://social-media-420-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "social-media-420",
            storageBucket: "social-media-420.appspot.com",
            messagingSenderId: "137093270524",
            appId: "1:137093270524:web:2847379ede160b6c73c079",
            measurementId: "G-G842MWTJKD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // --- DOM Element Selection ---
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const homeView = document.getElementById('home-view');
        const profileView = document.getElementById('profile-view');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const logoutBtn = document.getElementById('logout-btn');
        const homeBtn = document.getElementById('home-btn');
        const profileBtn = document.getElementById('profile-btn');
        const postForm = document.getElementById('post-form');
        const postText = document.getElementById('post-text');
        const charCount = document.getElementById('char-count');
        const postImage = document.getElementById('post-image');
        const postVideo = document.getElementById('post-video');
        const fileUploadStatus = document.getElementById('file-upload-status');
        const feed = document.getElementById('feed');
        const loadMoreBtn = document.getElementById('load-more');
        const profilePic = document.getElementById('profile-pic');
        const profilePicUpload = document.getElementById('profile-pic-upload');
        const changeProfilePicBtn = document.getElementById('change-profile-pic-btn');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const userPosts = document.getElementById('user-posts');

        // --- Global State ---
        let currentUser = null;
        let lastPostKey = null;
        const POSTS_PER_PAGE = 5;

        // --- Authentication Logic ---

        // Toggles between login and register forms
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // Handles user registration
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            registerError.textContent = '';

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Create a user profile entry in the Realtime Database
                    database.ref('users/' + userCredential.user.uid).set({
                        email: userCredential.user.email,
                        username: username,
                        profilePicUrl: 'https://via.placeholder.com/150' // Default profile picture
                    });
                })
                .catch(error => {
                    registerError.textContent = error.message;
                });
        });

        // Handles user login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                });
        });

        // Handles user logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Listens for authentication state changes
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                currentUser = user;
                authContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                homeView.classList.remove('hidden');
                profileView.classList.add('hidden');
                loadPosts(true); // Initial load of posts
                loadUserProfile(user.uid);
            } else {
                // User is signed out
                currentUser = null;
                authContainer.classList.remove('hidden');
                mainContent.classList.add('hidden');
                // Clear dynamic content
                feed.innerHTML = '';
                userPosts.innerHTML = '';
                lastPostKey = null;
            }
        });

        // --- UI Navigation ---

        homeBtn.addEventListener('click', () => {
            profileView.classList.add('hidden');
            homeView.classList.remove('hidden');
        });

        profileBtn.addEventListener('click', () => {
            homeView.classList.add('hidden');
            profileView.classList.remove('hidden');
        });

        // --- Social Media Posting ---

        // Updates character count for new posts
        postText.addEventListener('input', () => {
            const remaining = 280 - postText.value.length;
            charCount.textContent = remaining;
        });
        
        // Shows the name of the selected file
        postImage.addEventListener('change', () => {
            fileUploadStatus.textContent = postImage.files[0]?.name || '';
        });
        postVideo.addEventListener('change', () => {
            fileUploadStatus.textContent = postVideo.files[0]?.name || '';
        });

        // Handles the post submission form
        postForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = postText.value;
            const imageFile = postImage.files[0];
            const videoFile = postVideo.files[0];

            if (text.trim() === '' && !imageFile && !videoFile) {
                alert("Post cannot be empty!");
                return;
            }

            const postData = {
                author: currentUser.uid,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            if (imageFile) {
                const storageRef = storage.ref('post_media/' + Date.now() + '_' + imageFile.name);
                storageRef.put(imageFile).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(downloadURL => {
                        postData.mediaUrl = downloadURL;
                        postData.mediaType = 'image';
                        savePost(postData);
                    });
                });
            } else if (videoFile) {
                // Placeholder for video upload
                 const storageRef = storage.ref('post_media/' + Date.now() + '_' + videoFile.name);
                storageRef.put(videoFile).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(downloadURL => {
                        postData.mediaUrl = downloadURL;
                        postData.mediaType = 'video';
                        savePost(postData);
                    });
                });
            } else {
                savePost(postData);
            }
        });
        
        // Saves the post data to Firebase
        function savePost(postData) {
            const newPostKey = database.ref().child('posts').push().key;
            const updates = {};
            updates['/posts/' + newPostKey] = postData;
            updates['/user-posts/' + currentUser.uid + '/' + newPostKey] = true;

            database.ref().update(updates)
                .then(() => {
                    // Reset the form
                    postForm.reset();
                    charCount.textContent = '280';
                    fileUploadStatus.textContent = '';
                    loadPosts(true); // Reload posts to show the new one
                })
                .catch(error => {
                    console.error("Error saving post: ", error);
                    alert("Error saving post.");
                });
        }


        // --- Fetching and Displaying Posts ---

        // Loads posts for the main feed with pagination
        function loadPosts(reload = false) {
            if (reload) {
                feed.innerHTML = '';
                lastPostKey = null;
            }

            let query = database.ref('posts').orderByKey().limitToLast(POSTS_PER_PAGE + (lastPostKey ? 1 : 0));
            if (lastPostKey) {
                query = query.endBefore(lastPostKey);
            }
            
            query.once('value', snapshot => {
                const posts = [];
                snapshot.forEach(childSnapshot => {
                    posts.unshift({ key: childSnapshot.key, ...childSnapshot.val() });
                });

                if (posts.length > POSTS_PER_PAGE) {
                     posts.pop(); // Remove the overlapping post
                }
                
                if (posts.length < POSTS_PER_PAGE) {
                    loadMoreBtn.classList.add('hidden');
                } else {
                    lastPostKey = posts[posts.length - 1].key;
                    loadMoreBtn.classList.remove('hidden');
                }
                
                posts.forEach(post => {
                     if (!document.getElementById("feed-" + post.key)) {
                        displayPost(post, feed, "feed-");
                     }
                });
            });
        }

        loadMoreBtn.addEventListener('click', () => loadPosts(false));

        // Renders a single post element
        function displayPost(post, container, prefix = "") {
            database.ref('users/' + post.author).once('value', userSnapshot => {
                const userData = userSnapshot.val();
                if (!userData) return;

                const postElement = document.createElement('div');
                postElement.id = prefix + post.key;
                postElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4';

                let mediaHtml = '';
                if (post.mediaUrl) {
                    if (post.mediaType === 'image') {
                        mediaHtml = `<img src="${post.mediaUrl}" alt="Post image" class="mt-3 rounded-lg max-w-full h-auto">`;
                    } else if (post.mediaType === 'video') {
                        mediaHtml = `<video controls src="${post.mediaUrl}" class="mt-3 rounded-lg max-w-full h-auto"></video>`;
                    }
                }

                postElement.innerHTML = `
                    <div class="flex items-center mb-2">
                        <img src="${userData.profilePicUrl}" alt="User avatar" class="w-12 h-12 rounded-full mr-4">
                        <div>
                            <p class="font-bold text-lg">${userData.username}</p>
                            <p class="text-gray-500 text-sm">${new Date(post.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="text-gray-800">${post.text}</p>
                    ${mediaHtml}
                `;
                container.appendChild(postElement);
            });
        }


        // --- User Profile Logic ---
        
        // Loads the user's profile information
        function loadUserProfile(userId) {
            database.ref('users/' + userId).once('value', snapshot => {
                const userData = snapshot.val();
                profileUsername.textContent = userData.username;
                profileEmail.textContent = userData.email;
                profilePic.src = userData.profilePicUrl;
            });
            loadUserPosts(userId);
        }

        // Triggers the file input for profile picture change
        changeProfilePicBtn.addEventListener('click', () => {
            profilePicUpload.click();
        });

        // Handles the profile picture upload
        profilePicUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const storageRef = storage.ref('profile_pics/' + currentUser.uid);
            storageRef.put(file).then(snapshot => {
                snapshot.ref.getDownloadURL().then(downloadURL => {
                    // Update the database and the UI
                    database.ref('users/' + currentUser.uid).update({ profilePicUrl: downloadURL });
                    profilePic.src = downloadURL;
                });
            });
        });

        // Loads only the posts created by the current user
        function loadUserPosts(userId) {
            userPosts.innerHTML = '';
            database.ref('user-posts/' + userId).orderByKey().limitToLast(20).once('value', snapshot => {
                 const postIds = [];
                 snapshot.forEach(child => { postIds.unshift(child.key) });
                 
                 postIds.forEach(postId => {
                    database.ref('posts/' + postId).once('value', postSnapshot => {
                        if (postSnapshot.exists()) {
                           displayPost({ key: postSnapshot.key, ...postSnapshot.val() }, userPosts, "profile-");
                        }
                    });
                 });
            });
        }
    </script>
</body>
</html>
