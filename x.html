<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Clone</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Custom Styles & Overrides */
        body { background-color: #000; color: #e7e9ea; }
        .btn-primary { background-color: #1d9bf0; }
        .btn-primary:hover { background-color: #1a8cd8; }
        .nav-item:hover { background-color: rgba(231, 233, 234, 0.1); }
        .hidden { display: none; }
        .modal-overlay { background-color: rgba(91, 112, 131, 0.4); }
        .trending-item:hover { background-color: rgba(255, 255, 255, 0.03); }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2f3336; border-radius: 4px; }
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1d9bf0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-black text-gray-100">

    <!-- =========== LOADER OVERLAY =========== -->
    <div id="loader-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
        <div class="loader"></div>
    </div>

    <!-- =========== AUTHENTICATION VIEW =========== -->
    <div id="auth-view" class="hidden">
        <div class="flex min-h-screen items-center justify-center">
            <div class="w-full max-w-md p-8 space-y-6 bg-[#15181c] rounded-lg">
                <!-- Login Form -->
                <div id="login-form-container">
                    <h1 class="text-3xl font-bold text-center">Log in to X</h1>
                    <form id="login-form" class="mt-8 space-y-6">
                        <input id="login-email" type="email" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Email">
                        <input id="login-password" type="password" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password">
                        <button type="submit" class="w-full py-2 px-4 font-bold text-white bg-blue-500 rounded-full hover:bg-blue-600 focus:outline-none">Log in</button>
                    </form>
                    <div class="text-center mt-4">
                        <a href="#" id="show-forgot-password" class="text-sm text-blue-400 hover:underline">Forgot password?</a>
                        <p class="mt-2 text-sm">Don't have an account? <a href="#" id="show-register" class="text-blue-400 hover:underline">Sign up</a></p>
                    </div>
                </div>
                <!-- Register Form -->
                <div id="register-form-container" class="hidden">
                    <h1 class="text-3xl font-bold text-center">Create your account</h1>
                    <form id="register-form" class="mt-8 space-y-6">
                        <input id="register-username" type="text" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md" placeholder="Username">
                        <input id="register-email" type="email" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md" placeholder="Email">
                        <input id="register-password" type="password" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md" placeholder="Password">
                        <button type="submit" class="w-full py-2 px-4 font-bold text-white bg-blue-500 rounded-full hover:bg-blue-600">Sign up</button>
                    </form>
                    <p class="mt-4 text-center text-sm">Have an account already? <a href="#" id="show-login" class="text-blue-400 hover:underline">Log in</a></p>
                </div>
                <!-- Forgot Password Form -->
                <div id="forgot-password-container" class="hidden">
                    <h1 class="text-3xl font-bold text-center">Reset Password</h1>
                    <form id="forgot-password-form" class="mt-8 space-y-6">
                        <input id="forgot-email" type="email" required class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-md" placeholder="Enter your email">
                        <button type="submit" class="w-full py-2 px-4 font-bold text-white bg-blue-500 rounded-full hover:bg-blue-600">Send Reset Link</button>
                    </form>
                    <p class="mt-4 text-center text-sm"><a href="#" id="back-to-login" class="text-blue-400 hover:underline">Back to log in</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- =========== MAIN APPLICATION VIEW =========== -->
    <div id="app-view" class="hidden">
        <div class="container mx-auto flex">
            <!-- Left Navigation (Sidebar) -->
            <header class="w-16 md:w-64 border-r border-gray-800 h-screen sticky top-0 flex flex-col justify-between p-2">
                <div>
                    <div class="p-3 text-2xl"><i class="fab fa-xing"></i></div>
                    <nav id="main-nav" class="mt-5 space-y-2">
                        <a href="#home" class="nav-item flex items-center p-3 rounded-full"> <i class="fas fa-home text-xl w-8"></i> <span class="hidden md:inline ml-4 font-bold">Home</span></a>
                        <a href="#explore" class="nav-item flex items-center p-3 rounded-full"> <i class="fas fa-hashtag text-xl w-8"></i> <span class="hidden md:inline ml-4">Explore</span></a>
                        <a href="#notifications" class="nav-item flex items-center p-3 rounded-full"> <i class="fas fa-bell text-xl w-8"></i> <span class="hidden md:inline ml-4">Notifications</span></a>
                        <a href="#profile" class="nav-item flex items-center p-3 rounded-full"> <i class="fas fa-user text-xl w-8"></i> <span class="hidden md:inline ml-4">Profile</span></a>
                    </nav>
                    <button id="open-post-modal" class="mt-5 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-full hover:bg-blue-600"><span class="hidden md:inline">Post</span><i class="fas fa-feather-alt md:hidden"></i></button>
                </div>
                <div id="user-menu-button" class="p-2 rounded-full cursor-pointer hover:bg-gray-800">
                    <div class="flex items-center">
                        <img id="sidebar-profile-pic" src="" class="w-10 h-10 rounded-full bg-gray-700">
                        <div class="hidden md:inline ml-3">
                            <p id="sidebar-username" class="font-bold text-sm"></p>
                            <p id="sidebar-email" class="text-gray-500 text-sm"></p>
                        </div>
                        <i class="hidden md:inline fas fa-ellipsis-h ml-auto text-gray-500"></i>
                    </div>
                    <!-- User Menu Popover -->
                    <div id="user-menu-popover" class="absolute bottom-16 left-2 w-64 bg-black border border-gray-800 rounded-lg shadow-lg hidden">
                        <a href="#" id="logout-button" class="block w-full text-left px-4 py-3 hover:bg-gray-900 font-bold">Log out</a>
                    </div>
                </div>
            </header>

            <!-- Main Content (Timeline & Views) -->
            <main class="flex-1 border-r border-l border-gray-800" style="max-width: 600px;">
                <div id="main-content-area" class="h-screen overflow-y-auto">
                    <!-- Dynamic View Content will be injected here -->
                </div>
            </main>

            <!-- Right Sidebar (Trending & Search) -->
            <aside class="hidden lg:block w-96 p-4">
                <div class="sticky top-0">
                    <div class="bg-[#16181c] p-4 rounded-xl">
                        <h2 class="font-bold text-xl mb-4">What’s happening</h2>
                        <div id="trending-list-placeholder">
                           <!-- Trending topics will be dynamically populated here -->
                        </div>
                        <a href="#explore" class="text-blue-400 mt-4 block">Show more</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- =========== POST CREATION MODAL =========== -->
    <div id="post-modal" class="fixed inset-0 z-40 items-center justify-center modal-overlay hidden">
        <div class="bg-[#15181c] rounded-2xl w-full max-w-xl p-4">
            <button id="close-post-modal" class="text-2xl mb-2">&times;</button>
            <div class="flex space-x-4">
                <img id="modal-profile-pic" src="" class="w-12 h-12 rounded-full bg-gray-700">
                <div class="flex-1">
                    <textarea id="post-text-input" class="w-full bg-transparent text-xl focus:outline-none" rows="5" placeholder="What is happening?!"></textarea>
                    <div id="video-preview-container" class="mt-2 hidden">
                        <video id="video-preview" controls class="w-full rounded-lg"></video>
                        <p id="video-upload-status" class="text-sm text-gray-400 mt-1"></p>
                    </div>
                    <div class="flex justify-between items-center mt-4 border-t border-gray-800 pt-2">
                        <div>
                            <label for="video-upload-input" class="text-blue-500 cursor-pointer text-xl"><i class="fas fa-video"></i></label>
                            <input type="file" id="video-upload-input" accept="video/*" class="hidden">
                        </div>
                        <button id="submit-post-button" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full disabled:bg-blue-800 disabled:cursor-not-allowed">Post</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================= -->
    <!-- ============== JAVASCRIPT LOGIC ============= -->
    <!-- ============================================= -->
    
    <!-- Firebase SDKs - v9 Modular -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, query, orderBy, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // =======================================================================
        // YOUR FIREBASE CONFIGURATION OBJECT
        // =======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBF8WGFStX62SCFqhMzqcvIFI0LZTJfd30",
            authDomain: "social-media-420.firebaseapp.com",
            databaseURL: "https://social-media-420-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "social-media-420",
            storageBucket: "social-media-420.appspot.com", // Corrected storage bucket format
            messagingSenderId: "137093270524",
            appId: "1:137093270524:web:2847379ede160b6c73c079",
            measurementId: "G-G842MWTJKD"
        };
        // =======================================================================

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;

        // --- DOM Element References ---
        const D = (id) => document.getElementById(id);
        const authView = D('auth-view'), appView = D('app-view'), loaderOverlay = D('loader-overlay');
        const loginFormContainer = D('login-form-container'), registerFormContainer = D('register-form-container'), forgotPasswordContainer = D('forgot-password-container');
        const mainContentArea = D('main-content-area');
        const userMenuButton = D('user-menu-button'), userMenuPopover = D('user-menu-popover');

        // --- Global UI Handlers ---
        const showLoader = () => loaderOverlay.classList.remove('hidden');
        const hideLoader = () => loaderOverlay.classList.add('hidden');
        const toggleView = (isLoggedIn) => {
            authView.classList.toggle('hidden', isLoggedIn);
            appView.classList.toggle('hidden', !isLoggedIn);
        };

        // --- Authentication State Observer ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUser = { uid: user.uid, ...userDocSnap.data() };
                    updateUserInfoUI(currentUser);
                    toggleView(true);
                    navigateTo('home');
                } else {
                    console.error("User document not found in Firestore. Logging out.");
                    await signOut(auth);
                }
            } else {
                // User is signed out
                currentUser = null;
                toggleView(false);
                loginFormContainer.classList.remove('hidden');
                registerFormContainer.classList.add('hidden');
                forgotPasswordContainer.classList.add('hidden');
            }
            hideLoader();
        });

        // --- Authentication Form Logic ---
        D('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            showLoader();
            const email = D('login-email').value;
            const password = D('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => { alert(error.message); hideLoader(); });
        });

        D('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            showLoader();
            const username = D('register-username').value;
            const email = D('register-email').value;
            const password = D('register-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    // Create user document in Firestore
                    await setDoc(doc(db, "users", user.uid), {
                        username: username,
                        email: user.email,
                        createdAt: new Date(),
                        photoURL: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`, // Default avatar
                        bio: "New to X Clone!",
                    });
                })
                .catch(error => { alert(error.message); hideLoader(); });
        });

        D('forgot-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            showLoader();
            const email = D('forgot-email').value;
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert("Password reset email sent!");
                    hideLoader();
                    forgotPasswordContainer.classList.add('hidden');
                    loginFormContainer.classList.remove('hidden');
                })
                .catch(error => { alert(error.message); hideLoader(); });
        });

        D('logout-button').addEventListener('click', () => {
            showLoader();
            signOut(auth);
        });

        // --- Auth UI Toggling ---
        const toggleAuthForms = (show) => {
            loginFormContainer.classList.toggle('hidden', show !== 'login');
            registerFormContainer.classList.toggle('hidden', show !== 'register');
            forgotPasswordContainer.classList.toggle('hidden', show !== 'forgot');
        };
        D('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('register'); });
        D('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });
        D('show-forgot-password').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('forgot'); });
        D('back-to-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });

        // --- Main App UI Updates ---
        const updateUserInfoUI = (user) => {
            D('sidebar-profile-pic').src = user.photoURL;
            D('modal-profile-pic').src = user.photoURL;
            D('sidebar-username').textContent = user.username;
            D('sidebar-email').textContent = user.email;
        };
        
        userMenuButton.addEventListener('click', () => userMenuPopover.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuPopover.contains(e.target)) {
                userMenuPopover.classList.add('hidden');
            }
        });

        // --- Post Creation Logic ---
        const postModal = D('post-modal');
        const postTextInput = D('post-text-input');
        const videoUploadInput = D('video-upload-input');
        const videoPreviewContainer = D('video-preview-container');
        const videoPreview = D('video-preview');
        const videoUploadStatus = D('video-upload-status');
        const submitPostButton = D('submit-post-button');
        let videoFileToUpload = null;

        D('open-post-modal').addEventListener('click', () => postModal.classList.replace('hidden', 'flex'));
        D('close-post-modal').addEventListener('click', () => {
            postModal.classList.replace('flex', 'hidden');
            postTextInput.value = ''; videoUploadInput.value = '';
            videoFileToUpload = null; videoPreviewContainer.classList.add('hidden');
            videoPreview.src = ''; videoUploadStatus.textContent = '';
        });

        videoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                videoFileToUpload = file;
                videoPreview.src = URL.createObjectURL(file);
                videoPreviewContainer.classList.remove('hidden');
                videoUploadStatus.textContent = `Selected: ${file.name}`;
            }
        });

        submitPostButton.addEventListener('click', async () => {
            const text = postTextInput.value.trim();
            if (!text && !videoFileToUpload) return;
            showLoader(); submitPostButton.disabled = true;
            let videoURL = null;
            if (videoFileToUpload) {
                const filePath = `videos/${currentUser.uid}/${Date.now()}_${videoFileToUpload.name}`;
                const storageRef = ref(storage, filePath);
                const uploadTask = uploadBytesResumable(storageRef, videoFileToUpload);
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        videoUploadStatus.textContent = 'Upload is ' + progress.toFixed(0) + '% done';
                    }, (error) => reject(error),
                    async () => { videoURL = await getDownloadURL(uploadTask.snapshot.ref); resolve(); });
                });
            }
            await addDoc(collection(db, "posts"), {
                authorId: currentUser.uid, authorUsername: currentUser.username, authorPhotoURL: currentUser.photoURL,
                text: text, videoURL: videoURL, timestamp: new Date(),
                likesCount: 0, commentsCount: 0
            });
            hideLoader(); submitPostButton.disabled = false; D('close-post-modal').click();
        });

        // --- Navigation & View Rendering ---
        const navigateTo = (viewName) => {
            mainContentArea.innerHTML = ''; showLoader();
            switch (viewName) {
                case 'home': renderHomeTimeline(); renderTrendingSidebar(); break;
                case 'explore': renderExplorePage(); break;
                case 'notifications': renderNotificationsPage(); break;
                case 'profile': renderProfilePage(currentUser.uid); break;
            }
            hideLoader();
        };
        window.addEventListener('hashchange', () => navigateTo(location.hash.substring(1)));
        D('main-nav').addEventListener('click', (e) => {
            if (e.target.closest('a')) { const view = e.target.closest('a').hash.substring(1); navigateTo(view); }
        });

        // --- View Render Functions ---
        const renderHomeTimeline = () => {
            mainContentArea.innerHTML = `<div class="p-4 border-b border-gray-800"><h1 class="text-xl font-bold">Home</h1></div><div id="timeline-posts"></div>`;
            const postsContainer = D('timeline-posts');
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                postsContainer.innerHTML = '';
                snapshot.forEach(doc => { postsContainer.innerHTML += createPostHTML(doc.data()); });
            });
        };
        const renderExplorePage = () => {
            mainContentArea.innerHTML = `<div class="p-4 border-b border-gray-800"><h1 class="text-xl font-bold">Explore</h1></div><div id="explore-trending-list" class="p-4"></div>`;
            const trendingListContainer = D('explore-trending-list');
            const trendingHTML = `<div class="trending-item p-3 cursor-pointer"><p class="text-xs text-gray-500">Trending in Tech</p><p class="font-bold">#Firebase</p><p class="text-xs text-gray-500">1.2M Posts</p></div><div class="trending-item p-3 cursor-pointer"><p class="text-xs text-gray-500">Web Development</p><p class="font-bold">TailwindCSS</p><p class="text-xs text-gray-500">890K Posts</p></div>`;
            trendingListContainer.innerHTML = trendingHTML;
        };
        const renderTrendingSidebar = () => {
            const trendingSidebar = D('trending-list-placeholder');
            const trendingHTML = `<div class="trending-item p-3 cursor-pointer"><p class="text-xs text-gray-500">Trending in Tech</p><p class="font-bold">#Firebase</p><p class="text-xs text-gray-500">1.2M Posts</p></div><div class="trending-item p-3 cursor-pointer"><p class="text-xs text-gray-500">Web Development</p><p class="font-bold">TailwindCSS</p><p class="text-xs text-gray-500">890K Posts</p></div>`;
            trendingSidebar.innerHTML = trendingHTML;
        };
        const renderNotificationsPage = () => {
            mainContentArea.innerHTML = `<div class="p-4 border-b border-gray-800"><h1 class="text-xl font-bold">Notifications</h1></div><div class="p-4 text-center text-gray-500">No new notifications yet.</div>`;
        };
        const renderProfilePage = async (userId) => {
             const userDocRef = doc(db, "users", userId);
             const userDocSnap = await getDoc(userDocRef);
             if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                mainContentArea.innerHTML = `<div class="p-4 border-b border-gray-800"><h1 class="text-xl font-bold">${userData.username}</h1></div><div class="p-4"><img src="${userData.photoURL}" class="w-24 h-24 rounded-full mb-4"><h2 class="text-2xl font-bold">${userData.username}</h2><p class="text-gray-500">${userData.bio}</p></div><h3 class="p-4 font-bold border-t border-gray-800">Posts</h3><div id="profile-posts">Loading posts...</div>`;
             }
        };
        const createPostHTML = (postData) => {
            const postDate = postData.timestamp.toDate().toLocaleDateString();
            return `<div class="p-4 border-b border-gray-800 flex space-x-4"><img src="${postData.authorPhotoURL}" class="w-12 h-12 rounded-full bg-gray-700"><div class="flex-1"><div class="flex items-center space-x-2"><span class="font-bold">${postData.authorUsername}</span><span class="text-gray-500">· ${postDate}</span></div><p class="mt-1">${postData.text}</p>${postData.videoURL ? `<video src="${postData.videoURL}" controls class="mt-3 rounded-lg w-full"></video>` : ''}<div class="flex justify-between mt-4 text-gray-500 max-w-xs"><i class="far fa-comment cursor-pointer hover:text-blue-500"></i><i class="fas fa-retweet cursor-pointer hover:text-green-500"></i><i class="far fa-heart cursor-pointer hover:text-red-500"></i><i class="far fa-share-square cursor-pointer hover:text-blue-500"></i></div></div></div>`;
        };
        showLoader();
    </script>
</body>
</html>
